---
export const prerender = false;

import BaseLayout from "@/layouts/BaseLayout.astro";
import EventInfoBox from "@/components/Event/EventRegister/EventInfoBox.tsx";
import EventForm from "@/components/Event/EventRegister/EventForm";
import type { Event } from "@/types/event";

const getData = async (id: string) => {
  const res = await fetch(
    import.meta.env.PUBLIC_API_BASE_URL + `/events/${id}`
  );
  const data = await res.json();
  return data.event;
};

const { id, scheduleId } = Astro.params;

if (!id || !scheduleId) {
  return new Response("Event not found", { status: 404 });
}

const event: Event = await getData(id);

if (!event) {
  return new Response("Event not found", { status: 404 });
}

const schedule = event.schedules.find((s) => s.id === parseInt(scheduleId));

if (!schedule) {
  return new Response("Event not found", { status: 404 });
}

const date = new Date(schedule.starts_at).toLocaleDateString("th-TH", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const time = new Date(schedule.starts_at).toLocaleTimeString("th-TH", {
  hour: "2-digit",
  minute: "2-digit",
});

const faculty = event.faculty.name.th + " / " + event.faculty.name.en;
const name = event.name.en ? event.name.en : event.name.th;
const location = event.location.th + " / " + event.location.en;
---

<BaseLayout withNav={false} withFooter={false}>
  <div class="flex w-full flex-col items-center font-medium text-white">
    <h1 class="text-center text-3xl font-bold md:text-6xl">ลงทะเบียนกิจกรรม</h1>
    <h2
      class="mb-12 font-libre font-bold underline underline-offset-8 md:mb-12 md:text-3xl"
    >
      Event Registration
    </h2>
    <h1 class="mb-4 text-center text-5xl font-bold text-white">
      {name}
    </h1>
    <h2 class="mb-10 text-center text-2xl font-bold text-white">
      {faculty}
    </h2>
    <EventInfoBox eventDate={date} eventTime={time} eventLocation={location} />
    <EventForm
      eventDate={date}
      eventTime={time}
      eventName={name}
      eventFaculty={faculty}
      client:load
    />
  </div>
</BaseLayout>
